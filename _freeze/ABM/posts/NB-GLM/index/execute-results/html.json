{
  "hash": "0a0deaa3f003567c16b696b92095dd96",
  "result": {
    "markdown": "---\ntitle: \"Tratamiento para cucarachas\"\nsubtitle: \"GLMs de conteo\"\nauthor: \"Asael Alonzo Matamoros\"\ndate: \"2022-11-18\"\ncategories: [Poisson,GLM,code,analysis]\nimage: \"image.jpg\"\nbibliography: ref.bib\nformat: \n  html:\n    toc: true\n    code-copy: true\n    smooth-scroll: true\n    anchor-sections: true\n---\n\n\nEste post presenta un análisis la base `roaches` usando un modelo lineal generalizado de conteo. \n\nSe desea establecer la eficacia de cierto pesticida para el reducir el número de cucarachas en apartamentos urbanos. El tratamiento se aplicó a 158  de 262 apartamentos, $y$ es el número de cucarachas atrapadas después de aplicar dicho tratamiento. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(caret)\nlibrary(GGally)\nlibrary(ggplot2)\nlibrary(rstanarm)\nlibrary(flextable)\nlibrary(bayesplot)\nlibrary(ggfortify)\n\nbayesplot_theme_set(theme_grey())\n\ndata(roaches)\n```\n:::\n\n\nLos resultados del estudio se almacenan en la base de datos `roaches`, que contiene las siguiente variables.\n\n + `y`: número de cucarachas, después de aplicar el tratamiento. (**Dependiente**)\n\n + `roach1`: Número de cucarachas inicial.\n\n + `treatment`: Indicador de si recibió el tratamiento.\n \n + `senior`: Indicador si el residente era mayor.\n \n + `eposure2`: Número de días que se aplicó el tratamiento.\n \n## Verosimilitud\n \nLa variable `y` representa el número de cucarachas registradas al finalizar el tratamiento, dicha característica es representada por una v.a. discreta y positiva, y dicha característica debe ser considerada en el modelo.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmcmc_dens(roaches,pars = c(\"y\",\"roach1\"))+\n  labs(title = \"Gráfico de densidades para el número de cucarachas\",\n       subtitle = \"Pre|Post tratamiento\")\n```\n\n::: {.cell-output-display}\n![El gráfico izquierdo presenta las densidades de las dos variables de interés, el número de cucarachas previo y post exposición al tratamiento. Ambas variables muestran medias centradas en cero pero con colas bastante pesadas.](index_files/figure-html/fig-dens-1.png){#fig-dens width=672}\n:::\n:::\n\n\n@fig-dens muestra que ambas variables `y` y `roach1` son positivas, con colas derechas muy pesadas, para este tipo de datos existen dos alternativas:\n\n  + Modelar los datos con una distribución $\\log N(\\mu,\\sigma^2)$.\n  \n  + Modelar los datos con GLMs de conteo\n \nEn GLMs de conteo, la distribución mas popular debido a su simpleza es Poisson pero con una fuerte limitación que los datos poseen media y varianza iguales.  Para medir los efectos del tratamiento mediante un GLM de conteo de Poisson definimos la verosimilitud de tal forma que: \n\n$$y_i \\sim \\text{Poisson}(\\mu_i),\\quad g(\\mu_i) = \\log(\\mu_i), \\text{ y } \\mu_i = \\mu_0e^{\\beta X_i}.$$\nDonde:\n\n  + $\\mu_0$ se le conoce como la información previo a la exposición.\n  \n  + $g:\\mathbb R \\to \\mathbb R$, es la función de enlace logarítmica $g(x) = \\log x$\n  \n  + y $X$ son las covariables.\n\nEn un modelo log-normal, asumimos que los datos en escala logarítmica siguen un modelo normal \n\n$$\\log y_i\\sim N(\\mu_i,\\sigma^2), \\quad  g(\\mu_i) = \\mu_i, \\text{ y } \\mu_i = \\beta X_i.$$\nEs importante tener en cuenta que la función logarítmica es convexa, por ende no se puede aplicar la transformación inversa para obtener las predicciones en las escalas originales.  Recordar que si $y \\sim \\log N(\\mu,\\sigma^2)$ entonces:\n\n$$E[y] = e^{\\mu +1/2\\sigma}.$$\nFinalmente realizamos un gráfico de correlaciones para identificar las interacciones lineales entre variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggpairs(roaches )\n```\n\n::: {.cell-output-display}\n![Gráfico de pares. La diagonal principal muestra histogramas densidades de cada una de las variables. La parte superior muestra el coeficiente de correlación entre dos variables, fila y columna. La parte inferior muestra un gráfico de dispersión entre dos variables.](index_files/figure-html/fig-pairs-1.png){#fig-pairs width=672}\n:::\n:::\n\n\n@fig-pairs muestra resultados anti-intuitivos, se esperaría una alta correlación entre las variables `y` y `roach1`, dado que ambas miden la misma información pero en tiempos diferentes. Dado la poca correlación entre las variables consideramos un modelo completo que incluya todas las interacciones en el modelo.\n\n## Ajuste del modelo de Conteo de Poisson\n\nAjustamos el modelo GLM de conteo completo que consiste en usar todas las variables, y revisamos el ajuste e inferencia de los parámetros.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm1  = glm(y ~ roach1 + treatment + senior, offset = log(exposure2),\n            data = roaches, family = poisson)\n\nsummary(m1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = y ~ roach1 + treatment + senior, family = poisson, \n    data = roaches, offset = log(exposure2))\n\nDeviance Residuals: \n     Min        1Q    Median        3Q       Max  \n-17.9430   -5.1529   -3.8059    0.1452   26.7771  \n\nCoefficients:\n              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  3.089e+00  2.123e-02  145.49   <2e-16 ***\nroach1       6.983e-03  8.874e-05   78.69   <2e-16 ***\ntreatment   -5.167e-01  2.474e-02  -20.89   <2e-16 ***\nsenior      -3.799e-01  3.342e-02  -11.37   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 16954  on 261  degrees of freedom\nResidual deviance: 11429  on 258  degrees of freedom\nAIC: 12192\n\nNumber of Fisher Scoring iterations: 6\n```\n:::\n:::\n\n\nEl modelo completo da una impresión con buenos resultados, todas las variables son significativas pero los residuos no están centrados en cero, por ende no cumplen los supuestos iniciales. El siguiente código genera una muestra Bootstrap para los parámetros del modelo $M_1$.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nglm_boots = function(y,x,exposure,B = 1000){\n  n = length(y)\n  est = NULL\n  for (i in 1:B) {\n    si = sample(x = 1:n,size = n,replace = TRUE)\n    mli = glm(y[si]~x[si,], offset = log(exposure[si]),family = poisson)\n    ci = as.array(mli$coefficients)\n    est = rbind(est,ci)\n  }\n  # Estética\n  cn = colnames(x)\n  colnames(est) = c(\"intercepto\",cn)\n  \n  return(est)\n}\n```\n:::\n\n\nObtenemos una muestra Bootstrap para los estimadores $\\hat \\beta$ de tamaño $B = 2,000$ repeticiones\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbtp = glm_boots(y = roaches$y,\n               x = as.matrix(roaches[,2:4]),\n               exposure = roaches$exposure2,B = 2000)\n\ncolor_scheme_set(\"green\")\nmcmc_dens(btp)+labs(title=\"Distribución muestral de los estimadores, GLM Poisson\",\n                    subtitle =\"Bootstrap B = 2,000 iteraciones\")\n```\n\n::: {.cell-output-display}\n![Gráfico de densidades. Cada densidad representa la distribución muestral aproximada para cada uno de los estimadores usando un Bootstrap de B = 2,000 iteraciones.](index_files/figure-html/fig-btp1-1.png){#fig-btp1 width=672}\n:::\n:::\n\n\nLos intervalos de confianza al 95% son:\n\n\n::: {#tbl-btp1 .cell tbl-cap='Intervalos de confianza al 95%, obtenidos a partir de una muestra bootstrap de B = 2,000 iteraciones'}\n\n```{.r .cell-code}\nx = apply(btp,MARGIN = 2, FUN = quantile, probs = c(0.025,0.5,0.975)) \n\n# Estética\nx = data.frame( t(x) )\nx$pars = c(\"intercepto\",\"roach1\",\"treatment\",\"senior\")\ncolnames(x) = c(\"q2.5%\",\"Median\",\"q97.5%\",\"parámetros\")\n\nft = flextable(x[c(4,1,2,3)])\nautofit(ft)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"tabwid\"><style>.cl-463ab862{}.cl-46343ce4{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-46368120{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-46368134{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-46369110{width:1.058in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-4636911a{width:1.228in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-4636911b{width:1.058in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-4636911c{width:1.228in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-46369124{width:1.058in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-4636912e{width:1.228in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-4636912f{width:1.058in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-46369130{width:1.228in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-46369138{width:1.058in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-46369139{width:1.228in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-463ab862'><caption></caption><thead><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-46369110\"><p class=\"cl-46368120\"><span class=\"cl-46343ce4\">parámetros</span></p></td><td class=\"cl-4636911a\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">q2.5%</span></p></td><td class=\"cl-4636911a\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">Median</span></p></td><td class=\"cl-4636911a\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">q97.5%</span></p></td></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-4636911b\"><p class=\"cl-46368120\"><span class=\"cl-46343ce4\">intercepto</span></p></td><td class=\"cl-4636911c\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">2.644649555</span></p></td><td class=\"cl-4636911c\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">3.074843284</span></p></td><td class=\"cl-4636911c\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">3.435461027</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-46369124\"><p class=\"cl-46368120\"><span class=\"cl-46343ce4\">roach1</span></p></td><td class=\"cl-4636912e\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">0.005482779</span></p></td><td class=\"cl-4636912e\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">0.007119675</span></p></td><td class=\"cl-4636912e\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">0.009384559</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-4636912f\"><p class=\"cl-46368120\"><span class=\"cl-46343ce4\">treatment</span></p></td><td class=\"cl-46369130\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">-0.989904660</span></p></td><td class=\"cl-46369130\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">-0.537908236</span></p></td><td class=\"cl-46369130\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">-0.075859077</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-46369138\"><p class=\"cl-46368120\"><span class=\"cl-46343ce4\">senior</span></p></td><td class=\"cl-46369139\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">-1.053324226</span></p></td><td class=\"cl-46369139\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">-0.376491503</span></p></td><td class=\"cl-46369139\"><p class=\"cl-46368134\"><span class=\"cl-46343ce4\">0.165152478</span></p></td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nLos intervalos de confianza muestran que el efecto de la variable `roach1` esta concentrado en cero, por lo tanto, se deberá considerar un GLM de Poisson excluyendo dicha variable.\n\n## Ajuste del modelo log-normal \n\nAjustamos el modelo GLM log-normal completo que consiste en usar todas las variables, y revisamos el ajuste e inferencia de los parámetros. Hay que tomar en cuenta que al tomar `y` y `roach1` en escala logarítmica, se tendrán que descartar los valores infinitos obtenidos, dado que las distribuciones se acumulan en cero \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf = roaches\ndf[,1:2] = log(df[,1:2])\ndf = subset(df,subset = df$y != -Inf & df$roach1 != -Inf)\n\nm2 = lm(y~.,data = df)\nsummary(m2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = y ~ ., data = df)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-3.0679 -1.0726  0.2976  0.9884  2.8697 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  1.58442    0.40132   3.948 0.000122 ***\nroach1       0.52136    0.06408   8.137 1.62e-13 ***\ntreatment   -0.38609    0.21808  -1.770 0.078746 .  \nsenior      -0.38632    0.25848  -1.495 0.137187    \nexposure2   -0.19054    0.30949  -0.616 0.539082    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.299 on 146 degrees of freedom\nMultiple R-squared:  0.3315,\tAdjusted R-squared:  0.3132 \nF-statistic:  18.1 on 4 and 146 DF,  p-value: 4.281e-12\n```\n:::\n:::\n\n\nEl modelo completo da una mala impresión,hay variables no significativas, el coeficiente de determinación $\\hat R = 0.31$ es bastante cercano a cero, y  los residuos no están centrados en cero, por ende no cumplen los supuestos iniciales. Finalmente, revisamos los residuos del modelo, dado que los supuestos de normalidad pueden ser evaluados.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(m2)\n```\n\n::: {.cell-output-display}\n![Gráfico diagnóstico de los residuos, estos cuatro gráficos evaluan el ajuste y supuestos del modelo, si  algún comportamiento polinómico es persistente, entonces los supuestos del modelo no se satisfacen.](index_files/figure-html/fig-res1-1.png){#fig-res1 width=672}\n:::\n:::\n\n\n@fig-res1 muestra que los supuestos de normalidad en su mayoría si se cumplen, el gráfico inferior izquierdo muestra un comportamiento irregular, pero debido a que una observación es anómala e influenciable, por lo tanto, otro modelo a considerar es usando una distribución Student-t con grados de libertad cercanos a $v = 3$.\n\n## Modelo de Conteo, Binomial Negativa\n\nLa distribución Binomial negativa mide el número de éxitos que ocurren hasta el k-ésimo fracaso. Una v.a.d se distribuye Binomial Negativa ($y_i \\sim BN(k,p)$) si:\n\n$$f(y|p) = \\binom{y+k-1}{y}(1-p)^k p^y.$$\n\nDonde: \n\n + p es la probabilidad de éxito de un experimento Bernoulli.\n \n + k es el número de fracasos hasta tener el primer éxito\n \n + $E[y_i] = \\frac{pk}{1-p}$ es el valor esperado.\n \n + $V[y_i] = \\frac{pk}{(1-p)^2}$, es la varianza.\n \nEsta distribución se puede re-parametrizar en términos de su media $E[y_i] = \\mu$ y varianza $V[y] = \\sigma^2$.\n\n + $p = \\frac{\\sigma^2 - \\mu}{\\sigma^2},$\n \n + $k = \\frac{\\mu^2}{\\sigma^2 - \\mu}.$\n \n$$f(y) = \\binom{y+\\frac{\\mu^2}{\\sigma^2 - \\mu}-1}{y}\\left(\\frac{\\sigma^2 - \\mu}{\\sigma^2}\\right)^y \\left(\\frac{\\mu}{\\sigma^2}\\right)^{\\frac{\\mu^2}{\\sigma^2 - \\mu}}$$\n\nPara medir los efectos del tratamiento mediante un GLM de conteo de Binomial negativa, definimos la verosimilitud de tal forma que: \n\n$$y_i \\sim BN(\\mu_i,\\sigma^2)\\quad g(\\mu_i) = \\log(\\mu_i), \\text{ y } \\mu_i = \\mu_0e^{\\beta X_i}.$$\n\nDonde:\n\n  + $\\mu_0$ se le conoce como la información previo a la exposición.\n  \n  + $g:\\mathbb R \\to \\mathbb R$, es la función de enlace logarítmica $g(x) = \\log x$\n  \n  + y $X$ son las covariables.\n \n + El modelo no tiene la limitante que la varianza es la media $V[y_i] \\neq \\mu_i$.\n\nAjustamos el modelo GLM de conteo completo que consiste en usar todas las variables, y revisamos el ajuste e inferencia de los parámetros.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\n\nm3 = glm.nb(y ~ roach1 + treatment + senior + exposure2,data = roaches)\nsummary(m3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm.nb(formula = y ~ roach1 + treatment + senior + exposure2, \n    data = roaches, init.theta = 0.2717608411, link = log)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-1.8052  -1.3452  -0.6815  -0.0344   3.1831  \n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  2.393790   0.441811   5.418 6.02e-08 ***\nroach1       0.012764   0.001601   7.975 1.52e-15 ***\ntreatment   -0.764550   0.245659  -3.112  0.00186 ** \nsenior      -0.341062   0.264555  -1.289  0.19733    \nexposure2    0.435159   0.374132   1.163  0.24478    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for Negative Binomial(0.2718) family taken to be 1)\n\n    Null deviance: 338.89  on 261  degrees of freedom\nResidual deviance: 277.87  on 257  degrees of freedom\nAIC: 1792.7\n\nNumber of Fisher Scoring iterations: 1\n\n              Theta:  0.2718 \n          Std. Err.:  0.0259 \n\n 2 x log-likelihood:  -1780.7380 \n```\n:::\n:::\n\n\nEl modelo completo presenta mejores resultados que el modelo de Poisson pese que no todas las variables son significativas. Los residuos están centrados en cero y menos disperso, cumpliendo los supuestos iniciales. \n\n## Selección de modelos, 5-fold CV\n\nPara seleccionar el mejor modelo usaremos validación cruzada, 5-fold, esto implica que ajustaremos cinco veces cada modelo, evaluando la capacidad de aprendizaje usando $AIC$, $RMSE$ y $MAE$. Los modelos que se consideraran son los siguientes:\n\n + $M_1:$ Modelo de Poisson completo\n \n + $M_2:$ Modelo log-normal completo.\n \n + $M_3:$ Modelo Binomial Negativa completo.\n \n + $M_{3.1}:$ Modelo BN reducido, sin la variable `roach1`.\n\nEl siguiente código presenta una función para realizar **k-fold-CV** para cualquier valor de $k$. En caso de querer añadir otros modelos o criterios, la función deberá ser modificada.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nkfold = function(df,k){\n  # Generar la particion\n  kfld = createFolds(df[,1],k = k)\n  mat = NULL\n  \n  for (i in 1:k) {\n    # separar los datos en conjuntos de prueba y entrenamiento\n    dfE= df[-kfld[[i]],]\n    dfP = df[kfld[[i]],]\n    # Ajustar los modelos\n    m1  = glm(y ~ roach1 + treatment + senior, offset = log(exposure2),\n            data = dfE, family = poisson)\n    m3  = glm.nb(y ~ roach1 + treatment + senior + exposure2,data = roaches)\n    m31 =  glm.nb(y ~ treatment + senior + exposure2,data = roaches)\n    \n    p1  = predict(m1,dfP)\n    p3  = predict(m3,dfP)\n    p31 = predict(m31,dfP)\n    \n    # Calcular MAE\n    mae = c(\n             MAE(pred =  p1,obs = dfP[,1]),\n             MAE(pred =  p3,obs = dfP[,1]),\n             MAE(pred =  p31,obs = dfP[,1])\n            )\n\n    # Unir los datos\n    mat = rbind(mat,mae) \n  }\n  colnames(mat) = c(\"MAE1\",\"MAE3\",\"MAE31\")\n  row.names(mat) = NULL\n  return(mat)\n}\n\nkfold1 = function(df,k){\n  # Generar la particion\n  kfld = createFolds(df[,1],k = k)\n  mat = NULL\n  \n  for (i in 1:k) {\n    # separar los datos en conjuntos de prueba y entrenamiento\n    dfE= df[-kfld[[i]],]\n    dfP = df[kfld[[i]],]\n    # Ajustar los modelos\n    m2 = lm(y ~ .,data = dfE)\n    p2  = predict(m2,dfP)\n\n    # Unir los datos\n    mat = rbind(mat,MAE(pred =  p2,obs = dfP[,1])) \n  }\n  colnames(mat) = c(\"MAE2\")\n  row.names(mat) = NULL\n  return(mat)\n}\n```\n:::\n\n\n@tbl-cv compara los modelos de conteo, se observa que  en la mayoría de criterios el modelo Binomial Negativa completo, presenta los mejores resultados y el mejor ajuste, por lo tanto, seleccionamos al modelo $M_3$ que este deberá ser comparado con el modelo log-normal.\n\n\n::: {#tbl-cv .cell tbl-cap='Criterios de información del modelo log-N. Mediante Validación cruzada. La tabla presenta los criterios AIC, RMSE,  y MAE bajo un 5-fold cv.'}\n\n```{.r .cell-code  code-fold=\"true\"}\nrst = kfold(df = roaches,k = 5)\nx = t(apply(rst,MARGIN = 2,FUN = \"quantile\",probs = c(0.025,0.5,0.975)))\n\n# Estética\nx = data.frame(x)\nx$pars =  c(\"M1\",\"M3\",\"M3.1\")\n\ncolnames(x) = c(\"q2.5%\",\"Median\",\"q97.5%\",\"MAE\")\n\nrst1 = kfold1(df = df,k = 5)\nx1 = t(apply(rst1,MARGIN = 2,FUN = \"quantile\",probs = c(0.025,0.5,0.975)))\n\n# Estética\nx1 = data.frame(x1)\nx1$pars = c(\"M2\")\ncolnames(x1) = c(\"q2.5%\",\"Median\",\"q97.5%\",\"MAE\")\n\nx = rbind(x,x1)\n\nft = flextable(x[c(4,1,2,3)])\nautofit(ft)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"tabwid\"><style>.cl-472e7f42{}.cl-4728e96a{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-472ad842{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-472ad84c{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-472ae4c2{width:0.625in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4cc{width:1.007in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4cd{width:0.922in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4d6{width:0.625in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4d7{width:1.007in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4e0{width:0.922in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4ea{width:0.625in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4f4{width:1.007in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4f5{width:0.922in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4fe{width:0.625in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae4ff{width:1.007in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-472ae500{width:0.922in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table class='cl-472e7f42'><caption></caption><thead><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-472ae4c2\"><p class=\"cl-472ad842\"><span class=\"cl-4728e96a\">MAE</span></p></td><td class=\"cl-472ae4cc\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">q2.5%</span></p></td><td class=\"cl-472ae4cc\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">Median</span></p></td><td class=\"cl-472ae4cd\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">q97.5%</span></p></td></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-472ae4d6\"><p class=\"cl-472ad842\"><span class=\"cl-4728e96a\">M1</span></p></td><td class=\"cl-472ae4d7\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">19.760629</span></p></td><td class=\"cl-472ae4d7\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">23.350825</span></p></td><td class=\"cl-472ae4e0\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">35.08891</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-472ae4ea\"><p class=\"cl-472ad842\"><span class=\"cl-4728e96a\">M3</span></p></td><td class=\"cl-472ae4f4\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">19.687457</span></p></td><td class=\"cl-472ae4f4\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">23.170492</span></p></td><td class=\"cl-472ae4f5\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">34.81726</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-472ae4ea\"><p class=\"cl-472ad842\"><span class=\"cl-4728e96a\">M3.1</span></p></td><td class=\"cl-472ae4f4\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">19.783609</span></p></td><td class=\"cl-472ae4f4\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">23.537866</span></p></td><td class=\"cl-472ae4f5\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">35.42434</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-472ae4fe\"><p class=\"cl-472ad842\"><span class=\"cl-4728e96a\">M2</span></p></td><td class=\"cl-472ae4ff\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">0.977912</span></p></td><td class=\"cl-472ae4ff\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">1.042327</span></p></td><td class=\"cl-472ae500\"><p class=\"cl-472ad84c\"><span class=\"cl-4728e96a\">1.26739</span></p></td></tr></tbody></table></div>\n```\n:::\n:::\n\n\nContrario a los esperado, el modelo log-normal $M_2$ presenta mejores resultados que los modelos de conteos, por lo tanto el mejor modelo para medir el efecto de tratamientos en cucarachas desde un enfoque de aprendizaje es el modelo log-normal. \n\nEs importante resaltar que las predicciones realizadas con el modelo $M_2$ se realizaron en escala logarítmica, \n\n$$RMSE = \\frac{1}{\\sqrt n}||\\hat{\\log (y_P)} -\\log (y_P)||_2.$$\nEs necesario revisar si al transformar de forma inversa el modelo mantiene las predicciones. En caso de evaluar las predicciones en la escala natural de los datos, corroborar si:\n\n$$RMSE = \\frac{1}{\\sqrt n}||e^{\\mu_p+0.5\\sigma} -y_P||_2.$$\nDonde $\\mu_P$ son las predicciones obtenidas del modelo en escala logarítmica.\n\n## Referencias\n\n\n---\nnocite: |\n @Casella @degroot2012 @Miggon2014 @gelman2013 @BMLR2021 \n---\n\n\n::: {#refs}\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../site_libs/tabwid-1.1.0/tabwid.css\" rel=\"stylesheet\" />\n<link href=\"../../../site_libs/tabwid-1.1.0/scrool.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}